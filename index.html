<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Résidence Moeris - Assistant Virtuel Premium</title>
  
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

  <style>
    :root {
      --brand-color: #b88d0e; --brand-color-dark: #a37c0c; --background-light: #f9f4e8;
      --text-dark: #333; --text-light: #fff; --gray-light: #f3f4f6; --gray-medium: #e5e7eb;
      --shadow-light: rgba(0, 0, 0, 0.05); --shadow-medium: rgba(0, 0, 0, 0.1); --shadow-brand: rgba(184, 141, 14, 0.3);
      --font-family: 'Inter', sans-serif;
    }
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: var(--font-family, sans-serif); }
    iframe { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; border: none; }
    @keyframes subtlePulse { 0%, 100% { box-shadow: 0 0 0 0 var(--shadow-brand); } 50% { box-shadow: 0 0 0 12px rgba(184, 141, 14, 0); } }
    @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }
    @keyframes messageIn { from { transform: translateY(15px) scale(0.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
    .floating-button { background-color: var(--brand-color); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.3s ease; animation: subtlePulse 2.5s infinite; }
    .floating-button:hover { transform: scale(1.1); box-shadow: 0 10px 20px var(--shadow-brand); animation-play-state: paused; }
    #chatIcon { transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    .floating-button.open #chatIcon { transform: rotate(225deg); }
    .chat-window { opacity: 0; transform: translateY(20px) scale(0.95); transform-origin: bottom right; pointer-events: none; transition: opacity 0.4s ease, transform 0.4s ease; height: min(75vh, 700px); }
    .chat-window.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
    .chat-header { background: linear-gradient(135deg, var(--brand-color), #d4af37); border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
    .header-button { transition: transform 0.3s ease, color 0.3s ease; }
    .header-button:hover { transform: scale(1.2) rotate(10deg); color: rgba(255,255,255,0.8); }
    .chat-messages { background-color: var(--background-light); }
    .chat-messages::-webkit-scrollbar { width: 6px; }
    .chat-messages::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb { background: #d1b66a; border-radius: 10px; }
    .message-wrapper { animation: messageIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
    .message-bubble { box-shadow: 0 4px 10px var(--shadow-light); overflow-wrap: break-word; word-break: break-word; }
    #typingIndicator .dot { animation: typingBounce 1.4s infinite ease-in-out both; }
    #typingIndicator .dot:nth-child(1) { animation-delay: -0.32s; }
    #typingIndicator .dot:nth-child(2) { animation-delay: -0.16s; }
    .input-area { border-top: 1px solid var(--gray-medium); }
    #chatInput { background-color: var(--gray-light); transition: box-shadow 0.3s ease; resize: none; overflow-y: auto; line-height: 1.5; max-height: 120px; }
    #chatInput:focus { box-shadow: 0 0 0 2px var(--brand-color); }
    #actionButton { background-color: var(--brand-color); transition: background-color 0.3s ease, transform 0.3s ease, opacity 0.3s ease; }
    #actionButton.recording { transform: scale(1.15); background-color: #ef4444; }
    .emoji-picker-container { position: absolute; bottom: 100%; right: 0; margin-bottom: 10px; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; pointer-events: none; z-index: 100; }
    .emoji-picker-container.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .audio-player { display: flex; align-items: center; gap: 8px; }
    .play-pause-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; padding: 0; width: 30px; }
    .progress-bar-container { flex-grow: 1; height: 4px; background-color: rgba(255, 255, 255, 0.3); border-radius: 2px; cursor: pointer; }
    .progress-bar { height: 100%; width: 0; background-color: white; border-radius: 2px; }
    .audio-duration { font-size: 0.75rem; color: rgba(255, 255, 255, 0.8); }
  </style>
</head>
<body>

  <iframe src="https://residencemoeris.com" allow="autoplay; fullscreen; clipboard-write; geolocation; microphone; camera" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"></iframe>

  <div class="fixed bottom-6 right-6 z-50">
    <button id="chatToggleButton" class="floating-button w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-white text-3xl focus:outline-none">
      <i class="fa-solid fa-comment-dots" id="chatIcon"></i>
    </button>
  </div>

  <div id="chatWindow" class="chat-window fixed bottom-24 right-6 w-full max-w-sm bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden z-40 border border-gray-200">
    <div class="chat-header p-4 flex items-center justify-between shadow-md text-white">
      <div class="flex items-center">
        <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 text-2xl bg-white/10 border border-white/30">
          <i class="fa-solid fa-robot"></i>
        </div>
        <div>
          <h3 class="text-lg font-bold">Assistant Moeris</h3>
          <p class="text-xs text-yellow-200 flex items-center"><span class="w-2 h-2 bg-green-400 rounded-full mr-1.5"></span>En ligne</p>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <button id="clearChatButton" class="text-lg focus:outline-none header-button" title="Effacer la conversation"><i class="fas fa-eraser"></i></button>
        <button id="closeChatButton" class="text-xl focus:outline-none header-button"><i class="fas fa-chevron-down"></i></button>
      </div>
    </div>

    <div id="chatMessages" class="flex-grow p-4 space-y-4 overflow-y-auto chat-messages"></div>
    
    <div id="typingIndicator" class="hidden p-4 pt-0">
        <div class="flex items-center space-x-1.5 bg-gray-200 rounded-full px-3 py-2 w-max">
            <div class="dot w-2 h-2 bg-gray-500 rounded-full"></div>
            <div class="dot w-2 h-2 bg-gray-500 rounded-full"></div>
            <div class="dot w-2 h-2 bg-gray-500 rounded-full"></div>
        </div>
    </div>
    
    <div class="relative">
      <div id="emojiPickerContainer" class="emoji-picker-container"><emoji-picker class="light"></emoji-picker></div>
      <div class="input-area p-3 flex items-end bg-white space-x-2">
        <div class="flex-grow relative flex items-center">
            <textarea id="chatInput" placeholder="Posez une question..." rows="1" class="w-full border-none focus:ring-0 text-gray-700 py-2.5 pl-12 pr-4 rounded-full"></textarea>
            <button id="emojiButton" class="absolute left-2 top-2 text-gray-400 hover:text-yellow-600 focus:outline-none p-2"><i class="far fa-smile text-xl"></i></button>
        </div>
        <div class="relative w-12 h-12 flex items-center justify-center flex-shrink-0">
          <span id="recordingTimer" class="absolute -bottom-5 text-xs text-gray-500 font-mono hidden">0:00</span>
          <button id="actionButton" class="w-12 h-12 rounded-full flex items-center justify-center text-white text-xl focus:outline-none">
              <i class="fas fa-microphone" id="actionIcon"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const Chatbot = {
        N8N_WEBHOOK_URL: 'http://localhost:5678/webhook/5f855f34-9111-4ef3-b95b-17a7d750d658',
        isChatOpen: false, isRecording: false, mediaRecorder: null, audioChunks: [],
        timerInterval: null, audioStream: null, isLongPress: false, longPressTimer: null,
        sessionId: null,
        elements: {},

        init() {
          this.sessionId = crypto.randomUUID();
          this.elements = {
            chatToggleButton: document.getElementById('chatToggleButton'), chatWindow: document.getElementById('chatWindow'),
            closeChatButton: document.getElementById('closeChatButton'), clearChatButton: document.getElementById('clearChatButton'),
            chatMessages: document.getElementById('chatMessages'), chatInput: document.getElementById('chatInput'),
            actionButton: document.getElementById('actionButton'), actionIcon: document.getElementById('actionIcon'),
            typingIndicator: document.getElementById('typingIndicator'), recordingTimer: document.getElementById('recordingTimer'),
            emojiButton: document.getElementById('emojiButton'), emojiPickerContainer: document.getElementById('emojiPickerContainer'),
            emojiPicker: document.querySelector('emoji-picker'),
          };
          this.bindEvents();
          this.checkConfig();
          setTimeout(() => {
            this.addMessage("Bonjour ! Je suis l'assistant virtuel de la Résidence Moeris. Comment puis-je vous aider ?", 'bot');
          }, 500);
        },
        
        async sendToN8n(payload) {
            this.showTypingIndicator(true);
            try {
                const response = await fetch(this.N8N_WEBHOOK_URL, { method: 'POST', body: payload });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const result = await response.json();

                if (Array.isArray(result) && result.length > 0 && result[0].responseText) {
                    this.addMessage(result[0].responseText, 'bot');
                }

            } catch (error) {
                console.error('Erreur n8n:', error);
                this.addMessage("Désolé, une erreur de communication est survenue.", 'bot');
            } finally {
                this.showTypingIndicator(false);
            }
        },

        checkConfig() { if (!this.N8N_WEBHOOK_URL || this.N8N_WEBHOOK_URL === 'PASTE_YOUR_N8N_WEBHOOK_URL_HERE') { console.error("ERREUR CRITIQUE: L'URL du webhook N8N n'est pas configurée."); this.addMessage("Oups ! Il semble que je ne sois pas correctement configuré. L'envoi de messages est désactivé.", 'bot'); this.elements.chatInput.disabled = true; this.elements.actionButton.disabled = true; }},
        bindEvents() { const { elements } = this; elements.chatToggleButton.addEventListener('click', () => this.toggleChatWindow()); elements.closeChatButton.addEventListener('click', () => this.toggleChatWindow()); elements.clearChatButton.addEventListener('click', () => this.clearChat()); elements.chatInput.addEventListener('input', () => this.handleTextInput()); elements.chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.sendTextMessage(); } }); const actionUp = () => { clearTimeout(this.longPressTimer); if (this.isLongPress) { this.stopRecording(); } this.isLongPress = false; }; elements.actionButton.addEventListener('click', () => { if (!this.isLongPress) this.sendTextMessage(); }); elements.actionButton.addEventListener('mousedown', () => { this.longPressTimer = setTimeout(() => { this.isLongPress = true; this.startRecording(); }, 200); }); elements.actionButton.addEventListener('mouseup', actionUp); elements.actionButton.addEventListener('mouseleave', actionUp); elements.actionButton.addEventListener('touchstart', e => { e.preventDefault(); this.longPressTimer = setTimeout(() => { this.isLongPress = true; this.startRecording(); }, 200); }, { passive: false }); elements.actionButton.addEventListener('touchend', actionUp); elements.emojiButton.addEventListener('click', e => { e.stopPropagation(); this.toggleEmojiPicker(); }); elements.emojiPicker.addEventListener('emoji-click', e => this.insertEmoji(e.detail.unicode)); document.addEventListener('click', e => { if (!elements.emojiPickerContainer.contains(e.target) && elements.emojiPickerContainer.classList.contains('visible')) { this.toggleEmojiPicker(); } }); },
        toggleChatWindow() { this.isChatOpen = !this.isChatOpen; this.elements.chatWindow.classList.toggle('open'); this.elements.chatToggleButton.classList.toggle('open'); if (this.isChatOpen) { this.elements.chatInput.focus(); } },
        clearChat() { this.elements.chatMessages.innerHTML = ''; this.addMessage("Comment puis-je vous aider ?", 'bot'); },
        addMessage(content, sender) { const bubble = this.createMessageBubble(sender); const escapedContent = document.createElement('div'); escapedContent.textContent = content; bubble.innerHTML = this.parseSimpleMarkdown(escapedContent.innerHTML); this.appendMessage(bubble); },
        addAudioMessage(url, sender) { const bubble = this.createMessageBubble(sender); const audioId = `audio-${Date.now()}`; bubble.innerHTML = `<div class="audio-player" id="${audioId}"><button class="play-pause-btn"><i class="fas fa-play"></i></button><div class="progress-bar-container"><div class="progress-bar"></div></div><span class="audio-duration">--:--</span></div>`; this.appendMessage(bubble); setTimeout(() => this.setupAudioPlayer(audioId, url), 0); },
        createMessageBubble(sender) { const bubble = document.createElement('div'); bubble.className = `p-3 rounded-2xl max-w-[85%] message-bubble ${sender === 'user' ? 'bg-[var(--brand-color)] text-[#d4af37] rounded-br-none' : 'bg-gray-200 text-[var(--text-dark)] rounded-bl-none'}`; return bubble; },
        appendMessage(bubbleElement) { const wrapper = document.createElement('div'); const sender = bubbleElement.classList.contains('bg-[var(--brand-color)]') ? 'user' : 'bot'; wrapper.className = `flex message-wrapper ${sender === 'user' ? 'justify-end' : 'justify-start'}`; wrapper.appendChild(bubbleElement); this.elements.chatMessages.appendChild(wrapper); this.scrollToBottom(); },
        sendTextMessage() { const text = this.elements.chatInput.value.trim(); if (!text) return; this.addMessage(text, 'user'); const formData = new FormData(); formData.append('type', 'text'); formData.append('chatInput', text); formData.append('sessionId', this.sessionId); this.sendToN8n(formData); this.elements.chatInput.value = ''; this.handleTextInput(); },
        async startRecording() { if (this.elements.chatInput.value.trim().length > 0) return; if (this.isRecording) return; if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { this.addMessage("Désolé, votre navigateur ne supporte pas l'enregistrement vocal.", 'bot'); return; } try { this.audioStream = await navigator.mediaDevices.getUserMedia({ audio: true }); this.isRecording = true; this.audioChunks = []; this.elements.actionButton.classList.add('recording'); this.elements.recordingTimer.classList.remove('hidden'); this.elements.chatInput.disabled = true; this.mediaRecorder = new MediaRecorder(this.audioStream); this.mediaRecorder.start(); let seconds = 0; this.timerInterval = setInterval(() => { seconds++; this.elements.recordingTimer.textContent = `${Math.floor(seconds/60)}:${String(Math.floor(seconds%60)).padStart(2,'0')}`; }, 1000); this.mediaRecorder.ondataavailable = e => this.audioChunks.push(e.data); this.mediaRecorder.onstop = async () => { const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' }); if (audioBlob.size > 500) { const audioUrl = URL.createObjectURL(audioBlob); this.addAudioMessage(audioUrl, 'user'); const formData = new FormData(); formData.append('type', 'audio'); formData.append('file', audioBlob, 'recording.webm'); formData.append('sessionId', this.sessionId); await this.sendToN8n(formData); } if (this.audioStream) this.audioStream.getTracks().forEach(track => track.stop()); }; } catch (err) { console.error("Erreur de microphone:", err); if (err.name === 'NotAllowedError') { this.addMessage("Vous avez refusé l'accès au microphone.", 'bot'); } else { this.addMessage("Impossible d'accéder au microphone. Assurez-vous d'être sur une page HTTPS et d'autoriser l'accès.", 'bot'); } this.isLongPress = false; this.stopRecording(); }},
        stopRecording() { if (!this.isRecording) return; if (this.mediaRecorder && this.mediaRecorder.state === "recording") { this.mediaRecorder.stop(); } clearInterval(this.timerInterval); this.isRecording = false; this.elements.actionButton.classList.remove('recording'); this.elements.recordingTimer.classList.add('hidden'); this.elements.recordingTimer.textContent = "0:00"; this.elements.chatInput.disabled = false; },
        setupAudioPlayer(id, url) { const player = document.getElementById(id); if (!player) return; const audio = new Audio(url); const playBtn = player.querySelector('.play-pause-btn i'); const progressBar = player.querySelector('.progress-bar'); const durationSpan = player.querySelector('.audio-duration'); const progressBarContainer = player.querySelector('.progress-bar-container'); const formatTime = (time) => `${Math.floor(time/60)}:${String(Math.floor(time%60)).padStart(2,'0')}`; audio.addEventListener('loadedmetadata', () => { durationSpan.textContent = formatTime(audio.duration); }); audio.addEventListener('timeupdate', () => { progressBar.style.width = `${(audio.currentTime / audio.duration) * 100}%`; }); audio.addEventListener('ended', () => { playBtn.classList.replace('fa-pause', 'fa-play'); }); playBtn.parentElement.addEventListener('click', () => { if (audio.paused) { audio.play(); playBtn.classList.replace('fa-play', 'fa-pause'); } else { audio.pause(); playBtn.classList.replace('fa-pause', 'fa-play'); } }); progressBarContainer.addEventListener('click', (e) => { const rect = progressBarContainer.getBoundingClientRect(); const clickPosition = (e.clientX - rect.left) / rect.width; audio.currentTime = clickPosition * audio.duration; }); },
        scrollToBottom() { this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight; },
        showTypingIndicator(show) { this.elements.typingIndicator.classList.toggle('hidden', !show); if (show) this.scrollToBottom(); },
        handleTextInput() { const hasText = this.elements.chatInput.value.trim().length > 0; this.elements.actionIcon.classList.toggle('fa-paper-plane', hasText); this.elements.actionIcon.classList.toggle('fa-microphone', !hasText); this.adjustTextareaHeight(); },
        adjustTextareaHeight() { const ta = this.elements.chatInput; ta.style.height = 'auto'; ta.style.height = `${Math.min(ta.scrollHeight, 120)}px`; },
        toggleEmojiPicker() { this.elements.emojiPickerContainer.classList.toggle('visible'); },
        insertEmoji(unicode) { this.elements.chatInput.value += unicode; this.handleTextInput(); this.elements.chatInput.focus(); },
        parseSimpleMarkdown(text) { return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); }
      };

      Chatbot.init();
    });
  </script>

</body>
</html>